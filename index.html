<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HF File Frontend</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html, body {
  height: 100%;
  margin: 0;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
  background: #f0f2f5;
  color: #333;
}
body {
  display: flex;
  flex-direction: column;
}

#controls {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  background: #fff;
  border-bottom: 1px solid #ddd;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  position: sticky;
  top: 0;
  z-index: 10;
}

#controls select, #controls input {
  font-size: 13px;
  padding: 6px 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
}
#controls button {
  padding: 6px 14px;
  font-size: 13px;
  border: none;
  border-radius: 6px;
  background: #4f46e5;
  color: #fff;
  cursor: pointer;
}
#status {
  margin-left: auto;
  font-family: monospace;
  font-size: 12px;
  background: #eef2ff;
  padding: 4px 8px;
  border-radius: 6px;
}

#response {
  flex: 1;
  background: #fff;
  margin: 8px 12px 12px;
  border-radius: 8px;
  border: 1px solid #ddd;
  overflow: auto;
  padding: 12px;
  min-height: 300px;
}
</style>
</head>

<body>

<div id="controls">
  <select id="mode">
    <option value="stock">stock</option>
    <option value="index">index</option>
    <option value="screener">screener</option>
  </select>

  <select id="req_type"></select>

  <input id="name" style="width:75px">

  <input id="date_end" style="width:70px">
  <input id="date_start" style="width:70px; display:none">

  <input id="suffix" style="width:90px; display:none">

  <button id="fetchBtn" onclick="fetchFile()">Fetch</button>

  <div id="status">idle</div>
</div>

<div id="response"></div>

<script>
const HF_API = "https://eshan6704-hfapp.hf.space";

const REQ_TYPES = {
  stock: ["info","intraday","daily","nse_eq","qresult","result","balance","cashflow","dividend","split","other","stock_hist"],
  index: ["indices","open","preopen","fno","fiidii","events","index_highlow","stock_highlow","bhav","largedeals","bulkdeals","blockdeals","most_active","index_history","hlargedeals","pe_pb","total_returns"],
  screener: ["from_low","from_high","volume","delivery"]
};

const mode=document.getElementById("mode");
const req_type=document.getElementById("req_type");
const name=document.getElementById("name");
const date_start=document.getElementById("date_start");
const date_end=document.getElementById("date_end");
const suffix=document.getElementById("suffix");
const statusBar=document.getElementById("status");
const response=document.getElementById("response");
const fetchBtn=document.getElementById("fetchBtn");

function nowTime(){ return new Date().toLocaleTimeString("en-IN",{hour12:false}); }
function fyStart(){ const d=new Date(); const y=d.getMonth()>=3?d.getFullYear():d.getFullYear()-1; return `01-04-${y}`; }
function today(){ const d=new Date(); return `${String(d.getDate()).padStart(2,"0")}-${String(d.getMonth()+1).padStart(2,"0")}-${d.getFullYear()}`; }
function setStatus(t){statusBar.textContent=t}

function updateReqTypes(){
  req_type.innerHTML="";
  REQ_TYPES[mode.value].forEach(r=>{
    const o=document.createElement("option");
    o.value=r;
    o.textContent=r.toUpperCase();
    if(
      (mode.value==="stock" && r==="info") ||
      (mode.value==="index" && r==="indices") ||
      (mode.value==="screener" && r==="from_low")
    ) o.selected=true;
    req_type.appendChild(o);
  });

  if(mode.value==="stock"){
    name.value="ITC";
    date_start.value=fyStart();
    date_end.value=today();
  } else if(mode.value==="index"){
    name.value="NIFTY 50";
    date_start.value=fyStart();
    date_end.value=today();
  } else{
    name.value="";
    date_start.value="";
    date_end.value="";
  }
  suffix.value="";
}

mode.addEventListener("change",updateReqTypes);
window.addEventListener("load",updateReqTypes);

async function fetchFile(){
  const m=mode.value;
  const r=req_type.value;
  const n=name.value.trim();
  const ds=date_start.value;
  const de=date_end.value;
  const s=suffix.value.trim();

  let fname=`@${m}@${r}`;
  if(n) fname+=`@${n}`;
  if(de) fname+=`@${de}`;
  if(ds) fname+=`@${ds}`;
  if(s)  fname+=`@${s}`;
  fname+=".html";

  setStatus(`${nowTime()} | FETCHING | ${fname}`);
  fetchBtn.disabled=true;

  const t0=performance.now();
  try{
    const res=await fetch(`${HF_API}/file?name=${encodeURIComponent(fname)}`);
    const blob=await res.blob();
    const text=await blob.text();
    const dt=Math.round(performance.now()-t0);
    setStatus(`${nowTime()} | DONE | ${(blob.size/1024).toFixed(0)} KB | ${dt} ms | ${fname}`);
    renderByType(text);
  } catch(e){
    setStatus(`${nowTime()} | ERROR | ${fname}`);
    response.innerHTML=`<pre style="color:red">${e.message}</pre>`;
  } finally{
    fetchBtn.disabled=false;
  }
}

function renderByType(text){
  response.innerHTML = text; // always treat response as HTML
}
</script>

</body>
</html>
